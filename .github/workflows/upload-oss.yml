name: Upload to Aliyun OSS

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (e.g., v1.0.4)'
        required: true
        default: 'v1.0.4'

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½ Release æ–‡ä»¶
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ ‡ç­¾åï¼ˆæ”¯æŒæ‰‹åŠ¨è§¦å‘å’Œè‡ªåŠ¨è§¦å‘ï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TAG_NAME="${{ github.event.release.tag_name }}"
          fi
          
          echo "ğŸ“¦ ä¸‹è½½ Release: $TAG_NAME"
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          mkdir -p release-assets
          
          # ä¸‹è½½æ‰€æœ‰èµ„äº§
          gh release download "$TAG_NAME" --repo ${{ github.repository }} --dir ./release-assets
          
          echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆï¼š"
          ls -lh ./release-assets/

      - name: å®‰è£… OSS å·¥å…·
        run: |
          echo "ğŸ”§ ä¸‹è½½ ossutil..."
          wget -q http://gosspublic.alicdn.com/ossutil/1.7.18/ossutil64
          chmod +x ossutil64
          
          echo "ğŸ”‘ é…ç½® OSS è®¤è¯..."
          ./ossutil64 config -e ${{ secrets.OSS_ENDPOINT }} \
                              -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
                              -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      - name: ä¸Šä¼ åˆ° OSS
        run: |
          echo "â˜ï¸  ä¸Šä¼ æ–‡ä»¶åˆ°é˜¿é‡Œäº‘ OSS..."
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ° OSSï¼ˆç›´æ¥ä¸Šä¼ åˆ° releases/ ç›®å½•ï¼Œä¸åŒ…å« release-assets å­ç›®å½•ï¼‰
          ./ossutil64 cp -r ./release-assets/ oss://videotool-updates/releases/ -f -u
          
          echo "âœ… ä¸Šä¼ å®Œæˆï¼"
          echo ""
          echo "ğŸ“ è®¿é—®åœ°å€ï¼š"
          echo "https://videotool-updates.oss-cn-beijing.aliyuncs.com/releases/"
          
      - name: æ˜¾ç¤ºä¸Šä¼ ç»“æœ
        run: |
          echo "ğŸ“Š OSS æ–‡ä»¶åˆ—è¡¨ï¼š"
          ./ossutil64 ls oss://videotool-updates/releases/ -d


# 字幕正则替换规则说明

> 用于 SRT 转 ASS 格式时的文本预处理  
> 最后更新：2025-11-03

---

## 📋 规则总览

字幕转换过程中应用 **7 条正则表达式规则**，用于清理和格式化字幕文本。

---

## 🔍 详细规则说明

### 规则 1：移除 HTML 斜体标签

| 项目 | 内容 |
|------|------|
| **正则表达式** | `</?i>` |
| **替换为** | 空字符串 |
| **功能** | 移除 `<i>` 和 `</i>` HTML 标签 |

**示例：**
```
原文：这是<i>斜体</i>文字
结果：这是斜体文字
```

**说明：**
- SRT 格式支持 HTML 标签，但 ASS 格式不支持
- 移除标签，保留文字内容

---

### 规则 2：移除中文引号

| 项目 | 内容 |
|------|------|
| **正则表达式** | `[""]+` |
| **替换为** | 空字符串 |
| **功能** | 移除中文引号 `""`  |

**示例：**
```
原文："你好，世界！"
结果：你好，世界！
```

**说明：**
- 清除中文双引号
- 使字幕更简洁

---

### 规则 3：替换中文标点为空格

| 项目 | 内容 |
|------|------|
| **正则表达式** | `\s*[，。；、~·？！￥—]+\s*` |
| **替换为** | 一个空格 ` ` |
| **功能** | 替换中文标点符号为空格 |

**匹配的标点：**
- `,` 逗号
- `。` 句号
- `;` 分号
- `、` 顿号
- `~` 波浪号
- `·` 间隔号
- `?` 问号
- `!` 感叹号
- `￥` 人民币符号
- `—` 破折号

**示例：**
```
原文：你好，世界！这是测试。
结果：你好 世界 这是测试
```

**说明：**
- 包括标点前后的空格一起替换
- 统一用空格分隔

---

### 规则 4：格式化连字符（非开头）

| 项目 | 内容 |
|------|------|
| **正则表达式** | `(?<!^)\s*-\s*` |
| **替换为** | ` -`（空格 + 连字符） |
| **功能** | 格式化不在行首的连字符 |

**示例：**
```
原文：这是   -   连字符
结果：这是 -连字符
```

**说明：**
- `(?<!^)` 负向后瞻断言，确保不在开头
- 清理连字符前后的多余空格
- 保留一个空格在连字符前

---

### 规则 5：格式化开头连字符

| 项目 | 内容 |
|------|------|
| **正则表达式** | `^\s*-\s*` |
| **替换为** | `-`（连字符） |
| **功能** | 格式化行首的连字符 |

**示例：**
```
原文：  -  这是对话
结果：-这是对话
```

**说明：**
- 对话通常以 `-` 开头
- 移除连字符前后的空格

---

### 规则 6：替换英文标点为空格

| 项目 | 内容 |
|------|------|
| **正则表达式** | `[,?!;'"{}]+` |
| **替换为** | 一个空格 ` ` |
| **功能** | 替换英文标点符号为空格 |

**匹配的标点：**
- `,` 逗号
- `?` 问号
- `!` 感叹号
- `;` 分号
- `'` 单引号
- `"` 双引号
- `{` 左花括号
- `}` 右花括号

**示例：**
```
原文：Hello, world! This is a test.
结果：Hello  world  This is a test.
```

**说明：**
- 清理英文标点
- 用空格分隔单词

---

### 规则 7：去除首尾空格

| 项目 | 内容 |
|------|------|
| **正则表达式** | `(^\s+)\|(\s+$)` |
| **替换为** | 空字符串 |
| **功能** | 移除字幕开头和结尾的所有空格 |

**示例：**
```
原文：   你好世界   
结果：你好世界
```

**说明：**
- `^\s+` 匹配开头的空格
- `\s+$` 匹配结尾的空格
- 清理多余的首尾空白

---

## 🔄 应用顺序

规则按以下顺序依次应用：

```
1. 移除 HTML 标签 (<i>, </i>)
   ↓
2. 移除中文引号 ("")
   ↓
3. 替换中文标点为空格
   ↓
4. 格式化连字符（非开头）
   ↓
5. 格式化开头连字符
   ↓
6. 替换英文标点为空格
   ↓
7. 去除首尾空格
```

---

## 💡 完整示例

### 输入（SRT 原文）

```
"  你好，世界！这是<i>测试</i>字幕。Hello, world!  "
```

### 处理流程

```
规则1 → 你好，世界！这是测试字幕。Hello, world!
规则2 → 你好，世界！这是测试字幕。Hello, world!
规则3 → 你好 世界 这是测试字幕 Hello, world!
规则4 → （无匹配）
规则5 → （无匹配）
规则6 → 你好 世界 这是测试字幕 Hello  world
规则7 → 你好 世界 这是测试字幕 Hello  world
```

### 最终输出

```
"你好 世界 这是测试字幕 Hello  world"
```

---

## 🛠️ 技术实现

### 代码位置

- **文件**: `src/renderer/utils/subtitleConverter.ts`
- **函数**: `applyRegexRules()`

### 实现示例

```typescript
const regexRules = [
  { pattern: /<\/?i>/g, replacement: '' },
  { pattern: /[""]+/g, replacement: '' },
  { pattern: /\s*[，。；、~·？！￥—]+\s*/g, replacement: ' ' },
  { pattern: /(?<!^)\s*-\s*/gm, replacement: ' -' },
  { pattern: /^\s*-\s*/gm, replacement: '-' },
  { pattern: /[,?!;'"{}]+/g, replacement: ' ' },
  { pattern: /(^\s+)|(\s+$)/gm, replacement: '' }
];

function applyRegexRules(text: string): string {
  let result = text;
  for (const rule of regexRules) {
    result = result.replace(rule.pattern, rule.replacement);
  }
  return result;
}
```

---

## ⚙️ 配置选项

在字幕转换界面中，用户可以：

- ✅ **启用/禁用** 正则替换规则
- ✅ **查看** 规则说明
- ⚠️ 禁用规则将跳过所有文本清理

**推荐：** 保持启用，确保字幕格式统一。

---

## 📝 注意事项

### ✅ 适用场景

- SRT 转 ASS 格式
- 字幕文本清理
- 格式统一化

### ⚠️ 潜在问题

1. **标点丢失**：所有中英文标点都会被替换为空格
2. **语义变化**：引号、感叹号等有语气的标点会丢失
3. **空格增多**：多个连续标点会产生多个空格

### 💡 改进建议

如果需要保留某些标点：
1. 从规则中移除相应的字符
2. 或在应用规则前做特殊标记
3. 或在应用规则后做后处理

---

## 🔗 相关文档

- [新功能开发指南](./NEW_FEATURE_GUIDE.md) - 开发新功能参考
- [UI设计规范](./UI_DESIGN_GUIDE.md) - UI组件规范

---

**最后更新：2025-11-03**  
**文档版本：v1.0.0**

